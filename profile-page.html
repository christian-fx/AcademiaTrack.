<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Tracker - My Profile</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#135bec",
              "background-light": "#f6f6f8",
              "background-dark": "#101622",
              "success": "#10B981",
              "error": "#EF4444"
            },
            fontFamily: {
              "display": ["Lexend", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
    <style>
        /* Mobile Menu Styles */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .menu-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        
        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10B981;
        }
        
        .toast.error {
            background-color: #EF4444;
        }
        
        .profile-image {
            transition: all 0.3s ease;
        }
        
        .profile-image:hover {
            transform: scale(1.05);
        }
        
        .hidden {
            display: none;
        }
        
        /* Degree classification badges */
        .degree-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .first-class {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }
        
        .second-class-upper {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
        }
        
        .second-class-lower {
            background-color: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }
        
        .third-class {
            background-color: rgba(249, 115, 22, 0.2);
            color: #F97316;
        }
        
        .pass {
            background-color: rgba(156, 163, 175, 0.2);
            color: #9CA3AF;
        }
        
        .fail {
            background-color: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Image Upload Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Update Profile Picture</h3>
            <div class="space-y-4">
                <button id="camera-btn" class="flex w-full items-center justify-center gap-3 p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors">
                    <span class="material-symbols-outlined text-2xl text-primary">photo_camera</span>
                    <span class="font-medium">Take Photo</span>
                </button>
                <button id="gallery-btn" class="flex w-full items-center justify-center gap-3 p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors">
                    <span class="material-symbols-outlined text-2xl text-primary">photo_library</span>
                    <span class="font-medium">Choose from Gallery</span>
                </button>
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" id="cancel-upload" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg h-10 font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <!-- TopNavBar Component -->
        <header class="sticky top-0 z-10 w-full bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800">
            <div class="container mx-auto">
                <div class="flex items-center justify-between whitespace-nowrap px-4 sm:px-6 lg:px-8 py-3">
                    <div class="flex items-center gap-4 text-gray-900 dark:text-white">
                        <div class="size-6 text-primary">
                            <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_6_330)">
                                    <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                </g>
                                <defs>
                                    <clippath id="clip0_6_330"><rect fill="white" height="48" width="48"></rect></clippath>
                                </defs>
                            </svg>
                        </div>
                        <h2 class="text-lg font-bold tracking-[-0.015em] text-gray-900 dark:text-white">AcademicTrack</h2>
                    </div>
                    <div class="hidden md:flex flex-1 justify-end items-center gap-6">
                        <nav class="hidden md:flex items-center gap-8">
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="homepage.html">Dashboard</a>
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="progresspage.html">Progress</a>
                            <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="activities-page.html">Activities</a>
                            <a class="text-sm font-bold text-primary dark:text-primary" href="#">Profile</a>
                        </nav>
                        <button id="desktop-logout" class="hidden md:flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-9 px-4 bg-primary/20 text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30">
                            <span class="truncate">Log Out</span>
                        </button>
                    </div>
                    <button id="menu-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800">
                        <span class="material-symbols-outlined text-gray-800 dark:text-gray-200">menu</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="mobile-menu fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg z-50 md:hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="size-6 text-primary">
                        <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_6_330)">
                                <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                            </g>
                        </svg>
                    </div>
                    <h2 class="text-lg font-bold">AcademicTrack</h2>
                </div>
            </div>
             <nav class="p-4">
                <ul class="space-y-4">
                    <li>
                        <a href="homepage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Dashboard</a>
                    </li>
                    <li>
                        <a href="activitiespage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Activities</a>
                    </li>
                    <li>
                        <a href="progresspage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Progress</a>
                    </li>
                    <li>
                        <a href="profile-page.html" class="block text-primary font-medium py-2">Profile</a>
                    </li>
                    <li>
                        <a href="chatbot.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">ChatBot</a>
                    </li>
                    <li class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="mobile-logout" class="block w-full text-center bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Menu Overlay -->
        <div id="menu-overlay" class="menu-overlay fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
            <div class="max-w-5xl mx-auto">
                <!-- PageHeading Component -->
                <div class="mb-8">
                    <div class="flex flex-wrap justify-between gap-3">
                        <div class="flex min-w-72 flex-col gap-2">
                            <p class="text-3xl lg:text-4xl font-black tracking-[-0.033em] text-gray-900 dark:text-white">My Profile</p>
                            <p class="text-base font-normal text-gray-500 dark:text-gray-400">Manage your personal information and academic details in one place.</p>
                        </div>
                    </div>
                </div>

                <!-- Academic Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white dark:bg-background-dark/50 rounded-xl p-4 border border-gray-200 dark:border-gray-800 shadow-sm">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Current CGPA</p>
                        <p id="stats-cgpa" class="text-2xl font-bold text-gray-900 dark:text-white">0.00</p>
                        <p id="degree-classification" class="text-xs mt-1">No data yet</p>
                    </div>
                    <div class="bg-white dark:bg-background-dark/50 rounded-xl p-4 border border-gray-200 dark:border-gray-800 shadow-sm">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Semesters</p>
                        <p id="stats-semesters" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-background-dark/50 rounded-xl p-4 border border-gray-200 dark:border-gray-800 shadow-sm">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Courses</p>
                        <p id="stats-courses" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                    </div>
                    <div class="bg-white dark:bg-background-dark/50 rounded-xl p-4 border border-gray-200 dark:border-gray-800 shadow-sm">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Activities</p>
                        <p id="stats-activities" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Left Column: Profile Card -->
                    <div class="md:col-span-1">
                        <div class="p-6 bg-white dark:bg-background-dark/50 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm">
                            <!-- ProfileHeader Component -->
                            <div class="flex flex-col gap-4 items-center text-center">
                                <div class="relative">
                                    <div id="profile-image" class="profile-image bg-center bg-no-repeat aspect-square bg-cover rounded-full w-32 h-32 border-4 border-white dark:border-gray-800 shadow-lg" 
                                         data-alt="Student profile picture" 
                                         style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuADXEIFKpmDI_nuQA0VU5QWeuV1OXE66OEphRMkNWgSnj75K_Ha5IdXSW94JooEV0riprXR2V8K5tgV269BrPwS6_QNOWRE5fsEr8OnpG7S37cMs7dioPWX7nokh1iWJtl4QFp0KNtQkIqoa53qYNJV2zd_CKGrBFWvXS7A_1DLVzL4TIWIFEXV5nV4qThK5hNHpZdLr112_DC3YyWL_TPXlyR-bGeRRknZzb2ilXbRP900Atw6Go80wga1albCpTAGTVoYV0f-uQo");'>
                                    </div>
                                    <button id="change-photo-btn" class="absolute bottom-1 right-1 flex items-center justify-center size-8 rounded-full bg-primary text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark/50 shadow-lg">
                                        <span class="material-symbols-outlined text-base">photo_camera</span>
                                    </button>
                                </div>
                                <div class="flex flex-col items-center justify-center">
                                    <p id="profile-name" class="text-xl font-bold tracking-[-0.015em] text-gray-900 dark:text-white">Loading...</p>
                                    <p id="profile-email" class="text-sm text-gray-500 dark:text-gray-400">Loading...</p>
                                    <p id="profile-id" class="text-xs text-gray-400 dark:text-gray-500 mt-1">Student ID: Generating...</p>
                                </div>
                                <button id="open-image-modal" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                    <span class="truncate">Change Profile Picture</span>
                                </button>
                                
                                <!-- Quick Tips -->
                                <div class="w-full mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                    <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2">Profile Tips</h4>
                                    <ul class="text-xs text-blue-700 dark:text-blue-300 space-y-1">
                                        <li>• Keep your information updated</li>
                                        <li>• Use a clear profile photo</li>
                                        <li>• Review your academic progress regularly</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Information Card -->
                    <div class="md:col-span-2">
                        <div class="bg-white dark:bg-background-dark/50 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm">
                            <form id="profile-form">
                                <div class="p-6 md:p-8">
                                    <!-- Personal Information Section -->
                                    <h2 class="text-lg font-bold tracking-[-0.015em] text-gray-900 dark:text-white pb-4 border-b border-gray-200 dark:border-gray-800">Personal Information</h2>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
                                        <!-- Full Name TextField -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Full Name</p>
                                            <input id="full-name" name="fullName" class="form-input w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm" required/>
                                        </label>
                                        <!-- Email Address TextField -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Email Address</p>
                                            <input id="email" name="email" type="email" class="form-input w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm" required/>
                                        </label>
                                    </div>
                                </div>
                                <div class="p-6 md:p-8 border-t border-gray-200 dark:border-gray-800">
                                    <!-- Academic Information Section -->
                                    <h2 class="text-lg font-bold tracking-[-0.015em] text-gray-900 dark:text-white pb-4 border-b border-gray-200 dark:border-gray-800">Academic Information</h2>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
                                        <!-- University TextField -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">University / Institution</p>
                                            <input id="university" name="university" class="form-input w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm" required/>
                                        </label>
                                        <!-- Department TextField -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Major / Department</p>
                                            <input id="department" name="department" class="form-input w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm" required/>
                                        </label>
                                        <!-- Academic Level Dropdown -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Academic Level</p>
                                            <select id="level" name="level" class="form-select w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm" required>
                                                <option value="">Select Level</option>
                                                <option value="100">100 Level</option>
                                                <option value="200">200 Level</option>
                                                <option value="300">300 Level</option>
                                                <option value="400">400 Level</option>
                                                <option value="500">500 Level</option>
                                            </select>
                                        </label>
                                        <!-- Graduation Year TextField -->
                                        <label class="flex flex-col">
                                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Expected Graduation Year</p>
                                            <input id="graduation-year" name="graduationYear" type="number" min="2024" max="2030" class="form-input w-full resize-none rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-700 bg-background-light dark:bg-background-dark h-11 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-3 text-sm"/>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-3 p-6 bg-gray-50 dark:bg-background-dark/30 border-t border-gray-200 dark:border-gray-800 rounded-b-xl">
                                    <button type="button" id="cancel-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                        <span class="truncate">Cancel</span>
                                    </button>
                                    <button type="submit" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                                        <span class="truncate">Save Changes</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Mobile menu functionality
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuOverlay = document.getElementById('menu-overlay');

        function toggleMenu() {
            mobileMenu.classList.toggle('open');
            menuOverlay.classList.toggle('open');
            document.body.style.overflow = mobileMenu.classList.contains('open') ? 'hidden' : '';
        }

        menuToggle.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        // Close menu when clicking on links
        const menuLinks = document.querySelectorAll('#mobile-menu a');
        menuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                document.body.style.overflow = '';
            });
        });

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // User data management
        let currentUser = null;
        let userData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebaseUtils.getCurrentUser().then(user => {
                if (!user) {
                    window.location.href = 'login-page.html';
                    return;
                }

                currentUser = user;
                
                // Get user data from Firebase
                firebaseUtils.getUserData(user.uid).then(data => {
                    if (data) {
                        userData = data;
                        loadUserProfile();
                        setupEventListeners();
                    } else {
                        console.error('User data not found');
                        window.location.href = 'login-page.html';
                    }
                }).catch(error => {
                    console.error('Error fetching user data:', error);
                    window.location.href = 'login-page.html';
                });
            });
        });

        function loadUserProfile() {
            // Load personal information
            document.getElementById('full-name').value = userData.fullName || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('university').value = userData.university || '';
            document.getElementById('department').value = userData.department || '';
            document.getElementById('level').value = userData.level || '';
            document.getElementById('graduation-year').value = userData.graduationYear || '2026';

            // Update profile display
            document.getElementById('profile-name').textContent = userData.fullName || 'Student';
            document.getElementById('profile-email').textContent = userData.email || 'No email set';
            document.getElementById('profile-id').textContent = `Student ID: ${userData.id ? userData.id.slice(-8) : 'Generating...'}`;

            // Load profile image if exists
            if (userData.profileImage) {
                document.getElementById('profile-image').style.backgroundImage = `url(${userData.profileImage})`;
            }

            // Calculate and display stats
            calculateUserStats();
        }

        function calculateUserStats() {
            // CGPA Calculation using Nigerian grading system
            let totalCredits = 0;
            let totalGradePoints = 0;
            let totalCourses = 0;
            let totalActivities = 0;

            if (userData.semesters && userData.semesters.length > 0) {
                userData.semesters.forEach(semester => {
                    if (semester.courses && semester.courses.length > 0) {
                        totalCourses += semester.courses.length;
                        
                        semester.courses.forEach(course => {
                            if (course.units && course.grade) {
                                const credits = parseFloat(course.units);
                                const gradePoint = getGradePoint(course.grade);
                                
                                if (!isNaN(credits) && gradePoint !== null) {
                                    totalGradePoints += credits * gradePoint;
                                    totalCredits += credits;
                                }
                            }
                        });
                    }
                });
            }

            if (userData.activities) {
                totalActivities = userData.activities.length;
            }

            const cgpa = totalCredits > 0 ? (totalGradePoints / totalCredits) : 0;
            const totalSemesters = userData.semesters ? userData.semesters.length : 0;

            // Update stats display
            document.getElementById('stats-cgpa').textContent = cgpa.toFixed(2);
            document.getElementById('stats-semesters').textContent = totalSemesters;
            document.getElementById('stats-courses').textContent = totalCourses;
            document.getElementById('stats-activities').textContent = totalActivities;

            // Update degree classification
            updateDegreeClassification(cgpa);
        }

        function getGradePoint(grade) {
            // Nigerian grading system (5.0 scale)
            const gradePoints = {
                'A': 5.0,
                'B': 4.0,
                'C': 3.0,
                'D': 2.0,
                'E': 1.0,
                'F': 0.0
            };
            return gradePoints[grade] || null;
        }

        function updateDegreeClassification(cgpa) {
            const degreeElement = document.getElementById('degree-classification');
            
            if (cgpa === 0) {
                degreeElement.textContent = 'No data yet';
                degreeElement.className = 'text-xs mt-1 text-gray-500';
                return;
            }
            
            if (cgpa >= 4.5) {
                degreeElement.textContent = 'First Class';
                degreeElement.className = 'degree-badge first-class mt-1';
            } else if (cgpa >= 3.5) {
                degreeElement.textContent = 'Second Class Upper';
                degreeElement.className = 'degree-badge second-class-upper mt-1';
            } else if (cgpa >= 2.4) {
                degreeElement.textContent = 'Second Class Lower';
                degreeElement.className = 'degree-badge second-class-lower mt-1';
            } else if (cgpa >= 1.5) {
                degreeElement.textContent = 'Third Class';
                degreeElement.className = 'degree-badge third-class mt-1';
            } else if (cgpa >= 1.0) {
                degreeElement.textContent = 'Pass';
                degreeElement.className = 'degree-badge pass mt-1';
            } else {
                degreeElement.textContent = 'Fail';
                degreeElement.className = 'degree-badge fail mt-1';
            }
        }

        function setupEventListeners() {
            // Logout functionality
            document.getElementById('desktop-logout').addEventListener('click', logout);
            document.getElementById('mobile-logout').addEventListener('click', logout);

            // Form submission
            document.getElementById('profile-form').addEventListener('submit', saveProfile);

            // Cancel button
            document.getElementById('cancel-btn').addEventListener('click', function() {
                loadUserProfile(); // Reset form to current values
                showToast('Changes discarded', 'error');
            });

            // Image upload functionality
            const imageModal = document.getElementById('image-modal');
            const openImageModal = document.getElementById('open-image-modal');
            const changePhotoBtn = document.getElementById('change-photo-btn');
            const cancelUpload = document.getElementById('cancel-upload');
            const fileInput = document.getElementById('file-input');
            const cameraBtn = document.getElementById('camera-btn');
            const galleryBtn = document.getElementById('gallery-btn');

            openImageModal.addEventListener('click', () => imageModal.classList.remove('hidden'));
            changePhotoBtn.addEventListener('click', () => imageModal.classList.remove('hidden'));
            cancelUpload.addEventListener('click', () => imageModal.classList.add('hidden'));

            cameraBtn.addEventListener('click', function() {
                // In a real app, this would open the camera
                fileInput.click();
            });

            galleryBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Save the image data URL to user profile
                            userData.profileImage = e.target.result;
                            saveUserData();
                            
                            // Update the profile image display
                            document.getElementById('profile-image').style.backgroundImage = `url(${e.target.result})`;
                            
                            imageModal.classList.add('hidden');
                            showToast('Profile picture updated successfully!');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showToast('Please select a valid image file', 'error');
                    }
                }
            });
        }

        function saveProfile(e) {
            e.preventDefault();
            
            // Update user data from form
            userData.fullName = document.getElementById('full-name').value;
            userData.email = document.getElementById('email').value;
            userData.university = document.getElementById('university').value;
            userData.department = document.getElementById('department').value;
            userData.level = document.getElementById('level').value;
            userData.graduationYear = document.getElementById('graduation-year').value;

            saveUserData();
            loadUserProfile(); // Refresh displayed data
            showToast('Profile updated successfully!');
        }

        function saveUserData() {
            // Update user data in Firebase
            firebaseUtils.updateUserData(currentUser.uid, userData).then(() => {
                // Also update localStorage for quick access
                localStorage.setItem('academiatrack_current_user', JSON.stringify(userData));
            }).catch(error => {
                console.error('Error saving user data:', error);
                showToast('Error saving profile data', 'error');
            });
        }

        function logout() {
            firebaseUtils.signOut().then(() => {
                localStorage.removeItem('academiatrack_current_user');
                window.location.href = 'login-page.html';
            });
        }
    </script>
</body>
</html>