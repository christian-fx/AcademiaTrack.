<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AcademiaTrack Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#135bec",
              "background-light": "#f6f6f8",
              "background-dark": "#101622",
              "success": "#10B981",
              "warning": "#F59E0B",
              "error": "#EF4444"
            },
            fontFamily: {
              "display": ["Lexend", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        
        /* Mobile Menu Styles */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .menu-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        
        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .counter {
            font-variant-numeric: tabular-nums;
        }
        
        /* Degree classification badges */
        .degree-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .first-class {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }
        
        .second-class-upper {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
        }
        
        .second-class-lower {
            background-color: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }
        
        .third-class {
            background-color: rgba(249, 115, 22, 0.2);
            color: #F97316;
        }
        
        .pass {
            background-color: rgba(156, 163, 175, 0.2);
            color: #9CA3AF;
        }
        
        .fail {
            background-color: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <div class="flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-full max-w-5xl flex-1 px-4 md:px-8 lg:px-0">
                    <!-- TopNavBar -->
                    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 dark:border-gray-700 px-4 md:px-10 py-4 mb-8 bg-white/50 dark:bg-black/20 rounded-xl backdrop-blur-sm">
                        <div class="flex items-center gap-4 text-gray-900 dark:text-white">
                            <div class="size-6 text-primary">
                                <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_6_330)">
                                        <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                    </g>
                                    <defs>
                                        <clippath id="clip0_6_330"><rect fill="white" height="48" width="48"></rect></clippath>
                                    </defs>
                                </svg>
                            </div>
                            <h2 class="text-lg font-bold tracking-tight">AcademiaTrack</h2>
                        </div>
                        <div class="hidden md:flex flex-1 justify-end gap-8">
                            <div class="flex items-center gap-9">
                                <a class="text-sm font-medium text-primary dark:text-primary" href="homepage.html">Dashboard</a>
                                <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="progresspage.html">Progress</a>
                                <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="activities-page.html">Activities</a>
                                <a class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary" href="profile-page.html">Profile</a>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="user-name" class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                                <div id="profile-image" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-white dark:border-gray-800 shadow-sm" data-alt="User profile avatar image"></div>
                            </div>
                        </div>
                        <button id="menu-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800">
                            <span class="material-symbols-outlined text-gray-800 dark:text-gray-200">menu</span>
                        </button>
                    </header>

                    <!-- Mobile Menu -->
                    <div id="mobile-menu" class="mobile-menu fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg z-50 md:hidden">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="size-6 text-primary">
                                    <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_6_330)">
                                            <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                        </g>
                                    </svg>
                                </div>
                                <h2 class="text-lg font-bold">AcademiaTrack</h2>
                            </div>
                        </div>
                        <nav class="p-4">
                            <ul class="space-y-4">
                                <li>
                                    <a href="homepage.html" class="block text-primary font-medium py-2">Dashboard</a>
                                </li>
                                <li>
                                    <a href="activitiespage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Activities</a>
                                </li>
                                       <li>
                                    <a href="progresspage.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Progress</a>
                                </li>
                                <li>
                                    <a href="profile-page.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">Profile</a>
                                </li>
                                            <li>
                        <a href="chatbot.html" class="block text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary py-2">ChatBot</a>
                    </li>
                                <li class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button id="mobile-logout" class="block w-full text-center bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                                        Logout
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <!-- Menu Overlay -->
                    <div id="menu-overlay" class="menu-overlay fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

                    <main class="flex flex-col gap-8 w-full">
                        <!-- PageHeading -->
                        <div class="flex flex-wrap justify-between gap-3 px-4">
                            <div class="flex min-w-72 flex-col gap-2">
                                <p id="welcome-message" class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-tighter">Welcome back!</p>
                                <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Stay on top of your academic journey.</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-sm text-gray-500 dark:text-gray-400">
                                    Last updated: <span id="last-updated">Just now</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats Overview -->
                        <div class="px-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                                    <div class="text-2xl font-bold text-primary counter" id="total-courses-count">0</div>
                                    <div class="text-gray-600 dark:text-gray-400 text-sm">Total Courses</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                                    <div class="text-2xl font-bold text-success counter" id="total-semesters-count">0</div>
                                    <div class="text-gray-600 dark:text-gray-400 text-sm">Semesters</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                                    <div class="text-2xl font-bold text-warning counter" id="pending-activities">0</div>
                                    <div class="text-gray-600 dark:text-gray-400 text-sm">Pending Tasks</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                                    <div class="text-2xl font-bold text-primary counter" id="completed-courses">0</div>
                                    <div class="text-gray-600 dark:text-gray-400 text-sm">Completed</div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Grid Layout -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 px-4">
                            <!-- Left Column: Quick Actions & Upcoming -->
                            <div class="lg:col-span-2 flex flex-col gap-6">
                                <!-- Stats -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                    <div class="flex flex-col gap-2 rounded-xl p-6 border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm fade-in">
                                        <p class="text-gray-600 dark:text-gray-400 text-base font-medium leading-normal">Current CGPA</p>
                                        <p id="current-cgpa" class="text-gray-900 dark:text-white tracking-tight text-4xl font-bold leading-tight counter">0.00</p>
                                        <div id="degree-classification" class="text-sm font-medium leading-normal">
                                            <span class="degree-badge" id="degree-class">No data yet</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 rounded-xl p-6 border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm fade-in">
                                        <p class="text-gray-600 dark:text-gray-400 text-base font-medium leading-normal">Credits Earned</p>
                                        <p id="credits-earned" class="text-gray-900 dark:text-white tracking-tight text-4xl font-bold leading-tight counter">0</p>
                                        <p class="text-gray-500 dark:text-gray-500 text-sm font-medium leading-normal">out of 120</p>
                                    </div>
                                    <div class="flex flex-col gap-2 rounded-xl p-6 border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm fade-in">
                                        <p class="text-gray-600 dark:text-gray-400 text-base font-medium leading-normal">Current Level</p>
                                        <p id="current-level" class="text-gray-900 dark:text-white tracking-tight text-4xl font-bold leading-tight">100</p>
                                        <p id="user-department" class="text-gray-500 dark:text-gray-500 text-sm font-medium leading-normal truncate">Department</p>
                                    </div>
                                </div>

                             
                                <!-- SectionHeader for Upcoming Deadlines -->
                                <div class="flex justify-between items-center pt-4">
                                    <h3 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Upcoming Deadlines</h3>
                                    <a href="activitiespage.html" class="text-sm text-primary hover:text-primary/80 font-medium">View All</a>
                                </div>
                                
                                <!-- Upcoming Deadlines List -->
                                <div id="upcoming-deadlines" class="flex flex-col gap-3">
                                    <div class="flex items-center justify-between p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm">
                                        <div class="flex items-center gap-4">
                                            <div class="flex items-center justify-center size-10 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary">
                                                <span class="material-symbols-outlined">description</span>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-800 dark:text-gray-200">No upcoming deadlines</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">Add activities to see deadlines here</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Semesters -->
                                <div class="pt-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Recent Semesters</h3>
                                        <a href="progresspage.html" class="text-sm text-primary hover:text-primary/80 font-medium">Manage</a>
                                    </div>
                                    <div id="recent-semesters" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                        <!-- Semesters will be dynamically added here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Stats & Actions -->
                            <div class="lg:col-span-1 flex flex-col gap-6">
                                <!-- SectionHeader -->
                                <h3 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Quick Actions</h3>
                                
                                <!-- ButtonGroup -->
                                <div class="flex flex-col gap-3">
                                    <a href="progresspage.html" class="flex w-full cursor-pointer items-center justify-center gap-3 overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-colors">
                                        <span class="material-symbols-outlined">add_circle</span>
                                        <span class="truncate">Add New Semester</span>
                                    </a>
                                    <a href="activitiespage.html" class="flex w-full cursor-pointer items-center justify-center gap-3 overflow-hidden rounded-lg h-12 px-5 bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-base font-bold tracking-wide hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                                        <span class="material-symbols-outlined">assignment</span>
                                        <span class="truncate">Add Activity</span>
                                    </a>
                                    <a href="coursespage.html" class="flex w-full cursor-pointer items-center justify-center gap-3 overflow-hidden rounded-lg h-12 px-5 bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-base font-bold tracking-wide hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                                        <span class="material-symbols-outlined">school</span>
                                        <span class="truncate">View All Courses</span>
                                    </a>
                                </div>

                                <!-- Recent Activity Section -->
                                <div class="pt-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Recent Grades</h3>
                                        <a href="progresspage.html" class="text-sm text-primary hover:text-primary/80 font-medium">View All</a>
                                    </div>
                                    <div id="recent-grades" class="flex flex-col gap-3 mt-3">
                                        <div class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 shadow-sm">
                                            <div class="flex flex-col">
                                                <p class="font-semibold text-gray-800 dark:text-gray-200">No grades yet</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">Add courses to see grades here</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Academic Progress -->
                                <div class="pt-4">
                                    <h3 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-tight mb-3">Academic Progress</h3>
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-gray-600 dark:text-gray-400">Degree Completion</span>
                                            <span id="completion-percentage" class="text-sm font-bold text-primary">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                            <div id="completion-bar" class="bg-primary h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                            <span>Start</span>
                                            <span id="completion-text">Just getting started</span>
                                            <span>Graduation</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    <!-- Footer -->
                    <footer class="w-full mt-16 border-t border-gray-200 dark:border-gray-700 pt-8 pb-12">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 px-4">
                            <div class="flex items-center gap-4 text-gray-900 dark:text-white mb-4 sm:mb-0">
                                <div class="size-6 text-primary">
                                    <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_6_330)">
                                            <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                                        </g>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold">AcademiaTrack</h3>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center gap-6 text-sm">
                                <div class="flex items-center gap-6 mb-4 sm:mb-0">
                                    <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="homepage.html">Dashboard</a>
                                    <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="progresspage.html">Progress</a>
                                    <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="activitiespage.html">Activities</a>
                                </div>
                                <div class="flex items-center gap-6">
                                    <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="profile-page.html">Profile</a>
                                    <a class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary" href="help.html">Help</a>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Â© 2025 AcademiaTrack. Tracking success for <span id="footer-user-name" class="font-medium">students</span>.</p>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu functionality
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuOverlay = document.getElementById('menu-overlay');

        function toggleMenu() {
            mobileMenu.classList.toggle('open');
            menuOverlay.classList.toggle('open');
            document.body.style.overflow = mobileMenu.classList.contains('open') ? 'hidden' : '';
        }

        menuToggle.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        // Close menu when clicking on links
        const menuLinks = document.querySelectorAll('#mobile-menu a');
        menuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                document.body.style.overflow = '';
            });
        });

        // Logout functionality
        document.getElementById('mobile-logout').addEventListener('click', function() {
            firebaseUtils.signOut().then(() => {
                localStorage.removeItem('academiatrack_current_user');
                window.location.href = 'login-page.html';
            });
        });

        // User data and dashboard initialization
        let currentUser = null;
        let userData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebaseUtils.getCurrentUser().then(user => {
                if (!user) {
                    // Redirect to login if no user is logged in
                    window.location.href = 'login-page.html';
                    return;
                }

                // Get user data from Firebase
                firebaseUtils.getUserData(user.uid).then(data => {
                    if (data) {
                        userData = data;
                        currentUser = user;
                        initializeDashboard(userData);
                    } else {
                        console.error('User data not found');
                        window.location.href = 'login-page.html';
                    }
                }).catch(error => {
                    console.error('Error fetching user data:', error);
                    window.location.href = 'login-page.html';
                });
            });
        });

        function initializeDashboard(userData) {
            document.getElementById('welcome-message').textContent = `Welcome back, ${userData.fullName.split(' ')[0]}!`;
            document.getElementById('user-name').textContent = userData.fullName;
            document.getElementById('footer-user-name').textContent = userData.fullName.split(' ')[0];
            
            // Update profile image if available
            if (userData.profileImage) {
                document.getElementById('profile-image').style.backgroundImage = `url(${userData.profileImage})`;
            } else {
                document.getElementById('profile-image').style.backgroundImage = 'url("https://lh3.googleusercontent.com/aida-public/AB6AXuDmQOamLXW64I-sbmtjVzpU57DtK7XPIXvTqC8HKueihXloX4oEb1jqN2tspylb1QJVhILrLsT3Oz-JCpgiY5BvVlApewNT0DR3pu_j14DiyvTjZ5lKbSIsMcUwK2Ow0wZl0LEtGXfVCPtl_qKOmui63jcIIIjL1cSMJLXwzteqsL9w3rFnVYYUsXjnnkbBDuof613ZJjhmAej0X2PtZ2-nTQFtCNZ16vrgnnsfc2gxrnehVCT-3dLqgOYwNo52FQzFpITa-MfdWAQ")';
            }

            // Load user's academic data
            loadAcademicData(userData);
            updateLastUpdated();
        }

        function loadAcademicData(userData) {
            // Calculate comprehensive statistics
            let totalCredits = 0;
            let totalGradePoints = 0;
            let totalCourses = 0;
            let totalSemesters = 0;
            let recentGrades = [];
            let upcomingDeadlines = [];
            let pendingActivities = 0;
            let completedCourses = 0;

            // Process semesters and courses
            if (userData.semesters && userData.semesters.length > 0) {
                totalSemesters = userData.semesters.length;
                
                userData.semesters.forEach(semester => {
                    if (semester.courses && semester.courses.length > 0) {
                        totalCourses += semester.courses.length;
                        
                        semester.courses.forEach(course => {
                            if (course.units && course.grade) {
                                const credits = parseFloat(course.units);
                                const gradePoint = calculateGradePoint(course.grade);
                                
                                if (!isNaN(credits) && gradePoint !== null) {
                                    totalGradePoints += credits * gradePoint;
                                    totalCredits += credits;
                                    completedCourses++;

                                    // Add to recent grades
                                    if (course.grade && course.grade !== 'N/A') {
                                        recentGrades.push({
                                            name: course.title,
                                            course: `${semester.level} Level - ${semester.type}`,
                                            grade: course.grade,
                                            semester: `${semester.level} - ${semester.type}`
                                        });
                                    }
                                }
                            }
                        });
                    }
                });
            }

            // Process activities for deadlines
            if (userData.activities && userData.activities.length > 0) {
                const now = new Date();
                userData.activities.forEach(activity => {
                    if (activity.dueDate) {
                        const dueDate = new Date(activity.dueDate);
                        if (dueDate > now) {
                            upcomingDeadlines.push({
                                name: activity.name,
                                course: activity.course || 'General',
                                dueDate: activity.dueDate,
                                type: activity.type
                            });
                            pendingActivities++;
                        }
                    }
                });

                // Sort by due date
                upcomingDeadlines.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            }

            // Update all statistics
            updateStatistics(userData, totalCredits, totalGradePoints, totalCourses, totalSemesters, pendingActivities, completedCourses);
            updateRecentGrades(recentGrades);
            updateUpcomingDeadlines(upcomingDeadlines);
            updateRecentSemesters(userData.semesters);
            updateAcademicProgress(totalCredits, userData.level);
        }

        function updateStatistics(userData, totalCredits, totalGradePoints, totalCourses, totalSemesters, pendingActivities, completedCourses) {
            // Update CGPA
            const cgpa = totalCredits > 0 ? (totalGradePoints / totalCredits) : 0;
            animateCounter('current-cgpa', cgpa, 2);
            document.getElementById('credits-earned').textContent = totalCredits;
            document.getElementById('current-level').textContent = userData.level || '100';
            document.getElementById('user-department').textContent = userData.department || 'Not set';

            // Update quick stats
            animateCounter('total-courses-count', totalCourses);
            animateCounter('total-semesters-count', totalSemesters);
            animateCounter('pending-activities', pendingActivities);
            animateCounter('completed-courses', completedCourses);

            // Update degree classification
            updateDegreeClassification(cgpa);
        }

        function updateDegreeClassification(cgpa) {
            const degreeElement = document.getElementById('degree-class');
            
            if (cgpa === 0) {
                degreeElement.textContent = 'No data yet';
                degreeElement.className = 'degree-badge';
                return;
            }
            
            if (cgpa >= 4.5) {
                degreeElement.textContent = 'First Class';
                degreeElement.className = 'degree-badge first-class';
            } else if (cgpa >= 3.5) {
                degreeElement.textContent = 'Second Class Upper';
                degreeElement.className = 'degree-badge second-class-upper';
            } else if (cgpa >= 2.4) {
                degreeElement.textContent = 'Second Class Lower';
                degreeElement.className = 'degree-badge second-class-lower';
            } else if (cgpa >= 1.5) {
                degreeElement.textContent = 'Third Class';
                degreeElement.className = 'degree-badge third-class';
            } else if (cgpa >= 1.0) {
                degreeElement.textContent = 'Pass';
                degreeElement.className = 'degree-badge pass';
            } else {
                degreeElement.textContent = 'Fail';
                degreeElement.className = 'degree-badge fail';
            }
        }

        function updateRecentGrades(recentGrades) {
            const container = document.getElementById('recent-grades');
            container.innerHTML = '';

            if (recentGrades.length > 0) {
                // Show only last 3 grades, most recent first
                recentGrades.slice(-3).reverse().forEach(grade => {
                    const gradeElement = document.createElement('div');
                    gradeElement.className = 'flex items-center justify-between p-3 rounded-xl bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 shadow-sm fade-in';
                    gradeElement.innerHTML = `
                        <div class="flex flex-col flex-1">
                            <p class="font-semibold text-gray-800 dark:text-gray-200 truncate">${grade.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${grade.semester}</p>
                        </div>
                        <div class="flex items-center justify-center size-10 rounded-full ${getGradeColorClass(grade.grade)} font-bold ml-3">
                            ${grade.grade}
                        </div>
                    `;
                    container.appendChild(gradeElement);
                });
            } else {
                container.innerHTML = `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex flex-col">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">No grades yet</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Add courses to see grades here</p>
                        </div>
                    </div>
                `;
            }
        }

        function updateUpcomingDeadlines(upcomingDeadlines) {
            const container = document.getElementById('upcoming-deadlines');
            container.innerHTML = '';

            if (upcomingDeadlines.length > 0) {
                upcomingDeadlines.slice(0, 4).forEach(deadline => {
                    const deadlineElement = document.createElement('div');
                    deadlineElement.className = 'flex items-center justify-between p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm fade-in';
                    
                    const icon = getActivityIcon(deadline.type);
                    const dueText = getDueText(deadline.dueDate);
                    
                    deadlineElement.innerHTML = `
                        <div class="flex items-center gap-4 flex-1">
                            <div class="flex items-center justify-center size-10 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary">
                                <span class="material-symbols-outlined">${icon}</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-gray-800 dark:text-gray-200 truncate">${deadline.name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${deadline.course}</p>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <p class="font-medium text-gray-700 dark:text-gray-300 text-sm">${formatDate(deadline.dueDate)}</p>
                            <p class="text-sm ${dueText.color}">${dueText.text}</p>
                        </div>
                    `;
                    container.appendChild(deadlineElement);
                });
            } else {
                container.innerHTML = `
                    <div class="flex items-center justify-between p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center justify-center size-10 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary">
                                <span class="material-symbols-outlined">description</span>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200">No upcoming deadlines</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Add activities to see deadlines here</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateRecentSemesters(semesters) {
            const container = document.getElementById('recent-semesters');
            container.innerHTML = '';

            if (semesters && semesters.length > 0) {
                // Show only last 2 semesters
                semesters.slice(-2).reverse().forEach(semester => {
                    const semesterElement = document.createElement('div');
                    semesterElement.className = 'bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 shadow-sm fade-in';
                    
                    const courseCount = semester.courses ? semester.courses.length : 0;
                    const gpa = semester.gpa || 0;
                    
                    semesterElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">${semester.level} Level</h4>
                            <span class="text-sm font-semibold ${gpa >= 3.5 ? 'text-green-600' : gpa >= 2.4 ? 'text-yellow-600' : 'text-red-600'}">${gpa.toFixed(2)} GPA</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${semester.type} ${semester.year}</p>
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>${courseCount} courses</span>
                            <span>${getSemesterStatus(semester)}</span>
                        </div>
                    `;
                    container.appendChild(semesterElement);
                });
            } else {
                container.innerHTML = `
                    <div class="col-span-2 bg-white dark:bg-gray-800 rounded-lg p-6 text-center border border-gray-200 dark:border-gray-700 shadow-sm">
                        <p class="text-gray-600 dark:text-gray-400">No semesters added yet</p>
                        <a href="progresspage.html" class="text-primary hover:text-primary/80 text-sm font-medium mt-2 inline-block">Add your first semester</a>
                    </div>
                `;
            }
        }

        function updateAcademicProgress(totalCredits, level) {
            const levelProgress = {
                '100': { percentage: 20, text: 'Start' },
                '200': { percentage: 40, text: 'Getting there' },
                '300': { percentage: 60, text: 'Half way there' },
                '400': { percentage: 80, text: 'Soon keep it up' },
                '500': { percentage: 100, text: 'You made it' }
            };
            
            const progress = levelProgress[level] || { percentage: 0, text: 'Just getting started' };
            const completionPercentage = progress.percentage;
            
            // Animate progress bar
            setTimeout(() => {
                document.getElementById('completion-bar').style.width = `${completionPercentage}%`;
                document.getElementById('completion-percentage').textContent = `${completionPercentage}%`;
                document.getElementById('completion-text').textContent = progress.text;
            }, 100);
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // Utility functions
        function calculateGradePoint(grade) {
            // Nigerian grading system (5.0 scale)
            const gradePoints = {
                'A': 5.0,
                'B': 4.0,
                'C': 3.0,
                'D': 2.0,
                'E': 1.0,
                'F': 0.0
            };
            return gradePoints[grade] || 0;
        }

        function getGradeColorClass(grade) {
            if (grade === 'A') return 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400';
            if (grade === 'B') return 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-400';
            if (grade === 'C') return 'bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-400';
            if (grade === 'D' || grade === 'E') return 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400';
            return 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400';
        }

        function getActivityIcon(type) {
            const icons = {
                'assignment': 'description',
                'test': 'quiz',
                'practical': 'biotech',
                'exam': 'assignment'
            };
            return icons[type?.toLowerCase()] || 'description';
        }

        function getDueText(dueDate) {
            const now = new Date();
            const due = new Date(dueDate);
            const diffTime = due - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { text: 'Overdue', color: 'text-red-500 dark:text-red-400' };
            if (diffDays === 0) return { text: 'Due today', color: 'text-red-500 dark:text-red-400' };
            if (diffDays === 1) return { text: 'Due tomorrow', color: 'text-orange-500 dark:text-orange-400' };
            if (diffDays <= 3) return { text: `Due in ${diffDays} days`, color: 'text-orange-500 dark:text-orange-400' };
            if (diffDays <= 7) return { text: `Due in ${diffDays} days`, color: 'text-yellow-500 dark:text-yellow-400' };
            return { text: `Due in ${diffDays} days`, color: 'text-gray-500 dark:text-gray-400' };
        }

        function formatDate(dateString) {
            const options = { month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function getSemesterStatus(semester) {
            // Simple status based on current date and semester type
            const now = new Date();
            const currentYear = now.getFullYear();
            const isCurrentSemester = semester.year == currentYear;
            
            if (isCurrentSemester) {
                return 'Current';
            } else if (semester.year < currentYear) {
                return 'Completed';
            } else {
                return 'Upcoming';
            }
        }

        function animateCounter(elementId, targetValue, decimals = 0) {
            const element = document.getElementById(elementId);
            const currentValue = parseFloat(element.textContent) || 0;
            const duration = 1000;
            const steps = 30;
            const stepValue = (targetValue - currentValue) / steps;
            let currentStep = 0;

            const timer = setInterval(() => {
                currentStep++;
                const newValue = currentValue + (stepValue * currentStep);
                
                if (currentStep >= steps) {
                    element.textContent = targetValue.toFixed(decimals);
                    clearInterval(timer);
                } else {
                    element.textContent = newValue.toFixed(decimals);
                }
            }, duration / steps);
        }

        // Auto-refresh data when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && userData) {
                loadAcademicData(userData);
                updateLastUpdated();
            }
        });

        // Manual refresh every 30 seconds
        setInterval(() => {
            if (userData && !document.hidden) {
                // Re-fetch user data from Firebase
                firebaseUtils.getUserData(currentUser.uid).then(data => {
                    if (data) {
                        userData = data;
                        loadAcademicData(userData);
                        updateLastUpdated();
                    }
                });
            }
        }, 30000);
    </script>
</body>
</html>